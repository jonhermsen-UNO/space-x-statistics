<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.3/dist/cosmo/bootstrap.min.css" crossorigin="anonymous">

	<title>SpaceX Payloads</title>
</head>

<body>
	<nav class="position-sticky navbar navbar-expand-lg navbar-dark bg-dark" style="top:0;z-index:1;">
		<div class="container-fluid">
			<h1 class="navbar-brand my-0">SpaceX Payloads</h1>
			<form class="form-inline my-2 my-lg-0">
				<button type="button" class="btn btn-primary"
					data-toggle="modal" data-target="#dataModal">
					View raw data
				</button>
			</form>
		</div>
	</nav>

	<main id="app-main" class="container-fluid my-3">
		<div id="dataModal" class="modal">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<div class="modal-title h5">Raw data</div>
						<button type="button" class="close" data-dismiss="modal">
							<span>&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<pre class="bg-dark text-light"
							style="max-height:calc(100vh - 12rem)">{{ launches }}</pre>
						<a href="https://docs.spacexdata.com/?version=latest#bc65ba60-decf-4289-bb04-4ca9df01b9c1">
							View API documentation
						</a>
					</div>
				</div>
			</div>
		</div>

		<div class="text-center">
			Sampling
			<span class="badge badge-dark">{{ sample.length }}</span>
			of
			<span class="badge badge-dark">{{ payloads.length }}</span>
			Payloads
		</div>

		<div class="row">
			<div v-for="record in sample" class="col-12 col-md-6 col-xl-4 my-3">
				<div class="card">
					<div class="card-header">
						<div class="row align-items-center">
							<div class="col-2 text-center my-1 embed-responsive embed-responsive-21by9">
								<div class="embed-responsive-item text-center">
									<img :src="record.mission_patch_small" class="h-100">
								</div>
							</div>
							<div class="col-10 h4 m-0">{{ record.payload_id }}</div>
						</div>
					</div>
					<ul class="list-group list-group-flush">
						<li class="list-group-item">
							<span class="font-weight-bold">Mission:</span>
							#{{ record.flight_number }}
							{{ record.mission_name }}
						</li>
						<li class="list-group-item">
							<span class="font-weight-bold">Launched:</span>
							{{ moment.unix(record.launch_date_unix).format(dateFormat) }}
						</li>
						<li class="list-group-item">
							<span class="font-weight-bold">Deployed:</span>
							T+{{ record.payload_deploy }} seconds
							({{ moment.unix(record.launch_date_unix + record.payload_deploy).format(dateFormat) }})
						</li>
						<li class="list-group-item">
							<span class="font-weight-bold">Mass:</span>
							{{ record.payload_mass_kg }} kg
						</li>
						<li class="list-group-item">
							<span class="font-weight-bold">Orbit:</span>
							{{ record.orbitName }}
							({{ record.orbit }})
						</li>
						<li class="list-group-item">
							<span class="font-weight-bold">Mean motion:</span>
							{{ record.mean_motion }} revolutions
						</li>
					</ul>
				</div>
			</div>
		</div>
	</main>

	<script src="https://cdn.jsdelivr.net/npm/vue@2.6/dist/vue.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17/lodash.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/moment@2.24/moment.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.15/dist/umd/popper.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
	<script>
		(function () {
			"use strict";

			function getOrbit (value) {
				if (value === "LEO") return "Low Earth orbit";
				if (value === "ISS") return "International Space Station";
				if (value === "PO") return "Polar orbit";
				if (value === "GTO") return "Geostationary transfer orbit";
				if (value === "ES-L1") return "Sun-Earth L1";
				if (value === "SSO") return "Semi-synchronous orbit";
				if (value === "HCO") return "Heliocentric orbit";
				if (value === "HEO") return "Highly elliptical orbit";
				if (value === "MEO") return "Medium Earth orbit";
				if (value === "VLEO") return "Very low Earth orbit";
				if (value === "SO") return "Sub-orbital";
				if (value === "GEO") return "Geosynchronous orbit";

				return "Unknown";
			}

			function sampleData (data) {
				var dataSample = [];

				_.forEach(data, function (obj) {
					var launch = {};

					if (obj.upcoming === true) return;
					if (obj.launch_success === false) return;
					if (!obj.timeline || !obj.timeline.payload_deploy) return;
					if (obj.rocket.second_stage.payloads.length === 0) return;

					launch.flight_number = obj.flight_number;
					launch.mission_name = obj.mission_name;
					launch.launch_date_unix = obj.launch_date_unix;
					launch.mission_patch_small = obj.links.mission_patch_small;
					launch.payload_deploy = obj.timeline.payload_deploy;

					_.forEach(obj.rocket.second_stage.payloads, function (payload) {
						if (payload.payload_mass_kg === null) return;
						if (payload.orbit_params.mean_motion === null) return;

						launch.payload_id = payload.payload_id;
						launch.payload_mass_kg = payload.payload_mass_kg;
						launch.mean_motion = payload.orbit_params.mean_motion;
						launch.orbit = payload.orbit;
						launch.orbitName = getOrbit(payload.orbit);

						dataSample.push(_.clone(launch));
					});
				});

				return dataSample;
			}

			jQuery.getJSON("https://api.spacexdata.com/v3/launches", (dataRaw) => {
				var dataLaunches = _.filter(dataRaw, { upcoming: false });
				var dataPayloads = _.flatMap(dataLaunches, "rocket.second_stage.payloads");
				var dataSample = sampleData(dataRaw);

				new Vue({
					el: "#app-main",
					data: { 
						population: _.cloneDeep(dataRaw),
						launches: _.cloneDeep(dataLaunches),
						payloads: _.cloneDeep(dataPayloads),
						sample: _.cloneDeep(dataSample),
						dateFormat: "MM/DD/YYYY HH:mm"
					}
				});
			});
		})();
	</script>
</body>

</html>
